name: Update Plugin Version

on:
  push:
    branches:
      - master

jobs:
  update_version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Generate New Version
        id: version
        run: |
          # Get current date components
          YEAR=$(date +'%y')
          MONTH=$(date +'%m')
          DAY=$(date +'%d')
          
          # Extract current version from file
          CURRENT_VERSION=$(grep "define('THEBIBLE_VERSION'" thebible.php | grep -o "'[0-9]\.[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]'" | tr -d "'")
          # Fallback: try to parse from the 'Version:' line if define fails
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION=$(grep "Version:" thebible.php | grep -o "[0-9]\.[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]")
          fi
          echo "Current version: $CURRENT_VERSION"
          
          # Extract the counter part (last two digits)
          if [[ "$CURRENT_VERSION" =~ ^1\.([0-9]{2})\.([0-9]{2})\.([0-9]{2})\.([0-9]{2})$ ]]; then
            LAST_YEAR="${BASH_REMATCH[1]}"
            LAST_MONTH="${BASH_REMATCH[2]}"
            LAST_DAY="${BASH_REMATCH[3]}"
            LAST_COUNTER="${BASH_REMATCH[4]}"
            
            # Remove leading zeros if any
            LAST_COUNTER=$(echo "$LAST_COUNTER" | sed 's/^0*//')
            [ -z "$LAST_COUNTER" ] && LAST_COUNTER=0
            
            # Check if it's the same day
            if [ "$YEAR" = "$LAST_YEAR" ] && [ "$MONTH" = "$LAST_MONTH" ] && [ "$DAY" = "$LAST_DAY" ]; then
              # Same day, increment counter
              COUNTER=$((LAST_COUNTER + 1))
            else
              # New day, reset counter
              COUNTER=1
            fi
          else
            # If version format doesn't match, start with counter 1
            COUNTER=1
          fi
          
          # Format counter with leading zero if needed
          COUNTER_FORMATTED=$(printf "%02d" $COUNTER)
          
          # Create new version string (for display and file updates)
          NEW_VERSION="1.${YEAR}.${MONTH}.${DAY}.${COUNTER_FORMATTED}"
          echo "New version: $NEW_VERSION"
          
          # Set individual components as outputs (no dots)
          echo "major=1" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "counter=$COUNTER_FORMATTED" >> $GITHUB_OUTPUT
          
          # Also set a safe version string without dots for env vars
          echo "version_string=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Version in Files
        run: |
          # Access outputs from previous step
          MAJOR="${{ steps.version.outputs.major }}"
          YEAR="${{ steps.version.outputs.year }}"
          MONTH="${{ steps.version.outputs.month }}"
          DAY="${{ steps.version.outputs.day }}"
          COUNTER="${{ steps.version.outputs.counter }}"
          
          # Construct version string with dots
          VERSION_STRING="$MAJOR.$YEAR.$MONTH.$DAY.$COUNTER"
          
          # Update version in files
          sed -i -E "s/(Version:\s*)[0-9]+(\.[0-9]+){4}/\1$VERSION_STRING/" thebible.php
          sed -i -E "s/(define\('THEBIBLE_VERSION',\s*')([0-9]+(\.[0-9]+){4})('\))/\1$VERSION_STRING\4/" thebible.php
          
          # Debug: show what we think we changed
          echo "=== After update ==="
          grep "Version:" thebible.php || true
          grep "THEBIBLE_VERSION" thebible.php || true

      - name: Commit and Push Changes
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # Access version from previous step
          VERSION_STRING="${{ steps.version.outputs.version_string }}"
          
          git config --global user.name "dushanwegner"
          git config --global user.email "d@wgnr.es"
          git remote set-url origin https://x-access-token:$GH_PAT@github.com/dushanwegner/thebible.git
          git add thebible.php
          git commit -m "Update version to $VERSION_STRING" || echo "No changes to commit"
          git push origin master

      - name: Create GitHub Tag
        run: |
          # Access version from previous step
          VERSION_STRING="${{ steps.version.outputs.version_string }}"
          
          # Create and push tag
          git tag "v$VERSION_STRING" || echo "Tag exists"
          git push origin "v$VERSION_STRING" || echo "Tag push skipped"

      # No ZIP build or deploy steps
